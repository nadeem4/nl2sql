# GeneratorNode

## Purpose

The `GeneratorNode` is responsible for converting the abstract query plan (generated by the `PlannerNode`) into a concrete, syntactically correct SQL query. It uses `sqlglot` to handle dialect differences (e.g., PostgreSQL vs T-SQL) and enforces system-wide guardrails like row limits.

## Components

- **`sqlglot`**: A powerful SQL parser and transpiler library used to construct the query AST programmatically.
- **`DatasourceRegistry`**: Used to determine the profile and specific SQL dialect of the target database.

## Inputs

The node reads the following fields from `GraphState`:

- `state.plan`: The structured dictionary representing the logical query plan (SELECT, FROM, JOINs, WHERE, etc.).
- `state.datasource_id`: ID of the target datasource (used to resolve dialect).

## Outputs

The node updates the following fields in `GraphState`:

- `state.sql_draft`: The generated SQL query string.
- `state.reasoning`: Log entry showing the generated SQL and rationale.
- `state.errors`: Appends `PipelineError` if generation fails.

## Logic Flow

1. **Preparation**:
    - Validates presence of `datasource_id` and `plan`.
    - Retrieves the correct dialect capability (e.g., "postgres", "tsql") from the registry.
    - Determines the row limit (minimum of system limit or plan limit).

2. **AST Construction**:
    - Iteratively builds a `sqlglot.expressions.Select` object.
    - **SELECT**: specific columns or aggregates, handling aliases.
    - **FROM**: primary table.
    - **JOINs**: secondary tables with ON conditions.
    - **WHERE**: filters, handling distinct operators (`=`, `>`, `LIKE`, `IN`, etc.).
    - **GROUP BY / HAVING**: aggregation logic.
    - **ORDER BY**: sorting.
    - **LIMIT**: appends the row limit.

3. **Transpilation**:
    - Calls `query.sql(dialect=target_dialect)` to generate the final string string matching the target database's syntax.

## Error Handling

- **`MISSING_DATASOURCE_ID`**: If router failed to set a datasource.
- **`MISSING_PLAN`**: If planner failed to produce a plan.
- **`SQL_GEN_FAILED`**: If the plan contains invalid structure or references that `sqlglot` cannot parse.

## Dependencies

- `sqlglot` library
- `nl2sql.capabilities`
